#!/usr/bin/env python3

import sys
import time
import os

# gridappsd-python module
from gridappsd import GridAPPSD
from gridappsd.topics import service_output_topic

class PFTester(object):
    def __init__(self,gapps,simulation_id):
        self.simulation_id=simulation_id
        self.keepLoopingFlag=True
        self.initflag=False
        Ysample={'646.2': {'645.2': [-7.177543473834806, 6.6777250702760815], '646.2': [7.177543473834806, -6.6777250702760815], '645.3': [2.408564072415804, -0.9996874529053109]}, '645.2': {'645.2': [11.468753101398052, -10.603388331034477]}, '645.3': {'645.2': [-3.8413662321995776, 1.5680292873844999], '645.3': [11.547403560992565, -10.5543166996104]}, '646.3': {'645.2': [2.408564072415804, -0.9996874529053109], '646.2': [-2.408564072415804, 0.9996874529053109], '645.3': [-7.227430441158098, 6.647235703237981], '646.3': [7.227430441158098, -6.647235703237981]}, '633.1': {'632.1': [-5.101721003289041, 6.985139585892622], '633.1': [5.711732900073786, -8.09425212550125], '632.2': [1.9496979322397292, -1.5977989785282705], '632.3': [1.1062989313775142, -1.36444351446076]}, '632.1': {'632.1': [8.964122535860163, -19.18122536018968]}, '632.2': {'632.1': [-3.6409802401334397, 6.074534761169345], '632.2': [14.40230405757743, -23.995383389425534], '645.2': [-4.291209627563246, 3.9256632607583954], '645.3': [1.4328021597837735, -0.5683418344791888]}, '633.2': {'632.1': [1.9496979322397292, -1.5977989785282705], '633.1': [-1.9496979322397292, 1.5977989785282705], '632.2': [-5.553835275516068, 7.033605172313807], '633.2': [6.163847172300812, -8.142717711922433], '632.3': [1.622252142916253, -1.512053511080051]}, '632.3': {'632.1': [-1.6324374251853246, 4.1596613975185965], '632.2': [-4.2947347157825515, 5.949787754043844], '632.3': [13.001042473931935, -22.779556016521134], '645.2': [1.4328021597837735, -0.5683418344791888], '645.3': [-4.319973119834468, 3.9070809963724193]}, '633.3': {'632.1': [1.1062989313775142, -1.36444351446076], '633.1': [-1.1062989313775142, 1.36444351446076], '632.2': [1.622252142916253, -1.512053511080051], '633.2': [-1.622252142916253, 1.512053511080051], '632.3': [-4.999116670442115, 6.981351462850277], '633.3': [5.609128567226859, -8.090464002458905]}, '670.1': {'632.1': [-2.896439094541525, 9.14592109058647], '670.1': [4.345745078081807, -13.722312213933186], '632.2': [1.268303193021155, -3.357132195456374], '632.3': [0.39455455103697845, -2.096151393369206], '671.1': [-1.4493059835402824, 4.576391123346718], '671.2': [0.6346273291411181, -1.6798253371113294], '671.3': [0.19742527047386677, -1.0488619500204504]}, '670.2': {'632.1': [1.268303193021155, -3.357132195456374], '670.1': [-1.902930522162273, 5.036957532567704], '632.2': [-3.4175171762265593, 9.77586423423572], '670.2': [5.1275576537532785, -14.66746321715787], '632.3': [0.9296441042988564, -2.9016815961639324], '671.1': [0.6346273291411181, -1.6798253371113294], '671.2': [-1.7100404775267188, 4.89159898292215], '671.3': [0.46517075586446927, -1.4519292007812021]}, '670.3': {'632.1': [0.39455455103697845, -2.096151393369206], '670.1': [-0.5919798215108452, 3.1450133433896563], '632.2': [0.9296441042988564, -2.9016815961639324], '670.2': [-1.3948148601633257, 4.3536107969451345], '632.3': [-2.761119372819912, 8.91722801447202], '670.3': [4.142714737914346, -13.379186818412633], '671.1': [0.19742527047386677, -1.0488619500204504], '671.2': [0.46517075586446927, -1.4519292007812021], '671.3': [-1.3815953650944346, 4.461958803940613]}, 'RG60.1': {'632.1': [-0.9659624380295977, 3.050164683710586], 'RG60.1': [1282.0116967245226, -1284.0958989702035], '632.2': [0.4229791148725551, -1.1196035871847005], '632.3': [0.13158394277083205, -0.6990664896886299]}, 'RG60.2': {'632.1': [0.4229791148725551, -1.1196035871847005], 'RG60.1': [-0.4229791148725551, 1.1196035871847005], '632.2': [-1.1397419782715577, 3.2602507221176116], 'RG60.2': [1312.8681192770118, -1314.988628020858], '632.3': [0.31003630878366883, -0.9677108123206712]}, 'RG60.3': {'632.1': [0.13158394277083205, -0.6990664896886299], 'RG60.1': [-0.13158394277083205, 0.6990664896886299], '632.2': [0.31003630878366883, -0.9677108123206712], 'RG60.2': [-0.31003630878366883, 0.9677108123206712], '632.3': [-0.9208333108354406, 2.973895542826418], 'RG60.3': [1267.0273864683759, -1269.0804487003668]}, '671.1': {'671.1': [510.53324690553825, -517.2194925920319]}, '671.2': {'671.1': [-1.4805855588862282, 3.9190325114807303], '671.2': [503.98952443406984, -511.4121004271574]}, '671.3': {'671.1': [-2.8485967556551532, 3.3942313201963583], '671.2': [-1.085243373431807, 3.3873508254225446], '671.3': [510.4232171864894, -516.9215515502142]}, '680.1': {'671.1': [-1.9319248760591954, 6.100329367421172], '680.1': [1.9319248760591954, -6.100329367421172], '671.2': [0.8459582297451101, -2.239207174369401], '671.3': [0.2631678855416641, -1.3981329793772599]}, '680.2': {'671.1': [0.8459582297451101, -2.239207174369401], '680.1': [-0.8459582297451101, 2.239207174369401], '671.2': [-2.2794839565431153, 6.520501444235223], '680.2': [2.2794839565431153, -6.520501444235223], '671.3': [0.6200726175673377, -1.9354216246413425]}, '680.3': {'671.1': [0.2631678855416641, -1.3981329793772599], '680.1': [-0.2631678855416641, 1.3981329793772599], '671.2': [0.6200726175673377, -1.9354216246413425], '680.2': [-0.6200726175673377, 1.9354216246413425], '671.3': [-1.8416666216708812, 5.947791085652836], '680.3': [1.8416666216708812, -5.947791085652836]}, '684.1': {'671.1': [-7.152016045938744, 6.542772101263993], '684.1': [11.08326668569243, -8.61591551560366], '671.3': [2.3880035996396223, -0.9472363907986482]}, '684.3': {'671.1': [2.3880035996396223, -0.9472363907986482], '684.1': [-2.3880035996396223, 0.9472363907986482], '671.3': [-7.199955199724113, 6.5118016606207], '684.3': [13.717211839693459, -13.014974401054127]}, '611.3': {'684.3': [-6.517256639969346, 6.503172740433428], '611.3': [6.517256639969346, -6.485811629433428]}, '652.1': {'684.1': [-3.931250639753686, 2.073143414339668], '652.1': [3.931250639753686, -2.073143414339668]}, '675.1': {'692.1': [-10.318701103152023, 7.7681969473473345], '675.1': [10.318701103152023, -7.733526089347334], '692.2': [2.420684755830761, -3.002695220346295], '692.3': [1.077917412360271, -2.4591081761554436]}, '692.1': {'692.1': [510.318701103152, -507.76819694734735], '671.1': [-500.0, 500.0]}, '692.2': {'692.1': [-2.420684755830761, 3.002695220346295], '692.2': [511.44678084145966, -508.09006406005824], '671.2': [-500.0, 500.0]}, '675.2': {'692.1': [2.420684755830761, -3.002695220346295], '675.1': [-2.420684755830761, 3.002695220346295], '692.2': [-11.446780841459635, 8.090064060058225], '675.2': [11.446780841459635, -8.055393202058225], '692.3': [2.420684755830759, -3.0026952203462964]}, '692.3': {'692.1': [-1.077917412360271, 2.4591081761554436], '692.2': [-2.420684755830759, 3.0026952203462964], '692.3': [510.318701103152, -507.76819694734735], '671.3': [-500.0, 500.0]}, '675.3': {'692.1': [1.077917412360271, -2.4591081761554436], '675.1': [-1.077917412360271, 2.4591081761554436], '692.2': [2.420684755830759, -3.0026952203462964], '675.2': [-2.420684755830759, 3.0026952203462964], '692.3': [-10.318701103152017, 7.768196947347332], '675.3': [10.318701103152017, -7.733526089347332]}, '650.1': {'650.1': [1890.6787153073187, -5002.16597065552], 'RG60.1': [-1361.1110926793988, 1361.1110926793988], 'SOURCEBUS.1': [-9.283352668986778, 74.26682135189422], 'SOURCEBUS.3': [9.283352668986778, -74.26682135189422]}, '650.2': {'650.2': [1890.6787153073187, -5002.16597065552], 'RG60.2': [-1377.3147961636773, 1377.3147961636773], 'SOURCEBUS.2': [-9.283352668986778, 74.26682135189422], 'SOURCEBUS.1': [9.283352668986778, -74.26682135189422]}, '650.3': {'650.3': [1890.6787153073187, -5002.16597065552], 'RG60.3': [-1353.1513786871215, 1353.1513786871215], 'SOURCEBUS.3': [-9.283352668986778, 74.26682135189422], 'SOURCEBUS.2': [9.283352668986778, -74.26682135189422]}, 'SOURCEBUS.1': {'SOURCEBUS.1': [0.38776598322912115, -3.102127865832969]}, 'SOURCEBUS.2': {'SOURCEBUS.1': [-0.19388299161456057, 1.5510639329164846], 'SOURCEBUS.2': [0.38776598322912115, -3.102127865832969]}, 'SOURCEBUS.3': {'SOURCEBUS.1': [-0.19388299161456057, 1.5510639329164846], 'SOURCEBUS.2': [-0.19388299161456057, 1.5510639329164846], 'SOURCEBUS.3': [0.38776598322912115, -3.102127865832969]}, '634.1': {'633.1': [-5.286769772134454, 9.612308676608096], '634.1': [45.831692191831934, -83.32668288923477]}, '634.2': {'633.2': [-5.286769772134454, 9.612308676608096], '634.2': [45.831692191831934, -83.32668288923477]}, '634.3': {'633.3': [-5.286769772134454, 9.612308676608096], '634.3': [45.831692191831934, -83.32668288923477]}}
        Sinjsample={'1':[0,0], '2':[0,0], '3':[0,0], '4':[0,0], '5':[0,0], '6':[0,0], '7':[0,0], '8':[0,0], '9':[0,0],'10': [0,0],'11':[0,0], '12':[0,0], '13':[0,0], '14':[0,0],'15': [0,0], '16':[0,0], '17':[0,0], '18':[0,0], '19':[0,0], '20':[0,0], '21':[0,0], '22':[0,0], '23':[0,0], '24':[0,0], '25':[0,0], '26':[0,0], '27':[0,0], '28':[0,0], '29':[0,0], '30':[0,0], '31':[0,0], '32':[0,0], '33':[0,0], '34':[0,1], '35':[0,1], '36':[0,0], '37':[0,1], '38':[0,0], '39':[0,0], '40':[0,0], '41':[0,0]}
        Yempty={}
        Sinjempty={}

        gapps.subscribe(service_output_topic('gridappsd-power-flow',self.simulation_id),self)

        topic='goss.gridappsd.request.data.power-flow.'+self.simulation_id
        request={
            'requestType': "GET_SNAPSHOT_POWERFLOW",
            'Ybus': Ysample, # Set to Yempty if no input is to be given
            'Sinj': Sinjsample # Set to Sinjempty if no input is to be given
        }
        
        print('Requesting power flow solution for sim_id'+self.simulation_id+'\n',flush=True)
        message=gapps.get_response(topic,request,timeout=90)
        print('Got response'+str(message)+'\n',flush=True)
        print('\n\n')
        self.initflag=True

    def on_message(self,header,message):
        if 'processStatus' in message:
            if message['processStatus']=='COMPLETE' or message['processStatus']=='CLOSED':
                self.keepLoopingFlag = False
        elif self.initflag:
            print('\n')
            print('Received full PF solution with timestamp: '+str(message['timestamp'])+'\n')
            print(message['powerflow'])
            print(message['losses'])

def _main():
    if (os.path.isdir('shared')):
        sys.path.append('.')
    elif (os.path.isdir('../shared')):
        sys.path.append('..')

    if len(sys.argv) < 2:
        usestr =  '\nUsage: ' + sys.argv[0] + ' simulation_id\n'
        print(usestr, flush=True)
        exit()

    simulation_id = sys.argv[1]

    gapps = GridAPPSD() 

    pf=PFTester(gapps,simulation_id)

    print('Monitoring pf solutions')

    while pf.keepLoopingFlag:
        time.sleep(0.1)

    print('Finished monitoring PF results')

    gapps.disconnect()

if __name__ == '__main__':
  _main()

